version: 2.1

jobs:
    prepare-dependencies:
        docker:
            - image: circleci/node:stretch
        steps:
            - checkout
            - run:
                  name: Compute version number
                  command: echo "0.0.${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1:0:7}" | tee version.txt
            - restore_cache:
                  keys:
                      - yarn-packages-{{ checksum "yarn.lock" }}
            - run:
                  name: yarn install
                  command: yarn install --frozen-lockfile  
            - save_cache:
                  paths:
                      -  ~/.cache/yarn
                  key: yarn-packages-{{ checksum "yarn.lock" }}
            - store_artifacts:
                  path: yarn.lock
            - run: echo "Hello, world!" > workspace/echo-output
            - persist_to_workspace:
                  root: /tmp/workspace
                  paths:
                      - ./*

    build-production:
        docker:
            - image: brianoh1979/nodejs-circleci
        steps:
            - run: mkdir /tmp/workspace
            - attach_workspace:
                  at: /tmp/workspace
            - setup_remote_docker:
                version: 19.03.13
                docker_layer_caching: false
            - run:
                name: Build from dockerfile
                command: |
                  docker build . 
            - store_artifacts:
                  path: dist/server.js
            - persist_to_workspace:
                  root: .
                  paths:
                      - .

    test:
      machine: true
      steps:
        - run: mkdir /tmp/workspace
        - attach_workspace:
            at: /tmp/workspace
        - run: mkdir -p workspace
        - run: echo "Hello, world!" > workspace/echo-output
        - persist_to_workspace:
              # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is 
              # taken to be the root directory of the workspace.
              root: workspace
              # Must be relative path from root
              paths:
                  - echo-output

    test2:
        docker:
            - image: circleci/node:stretch
        steps:
            - attach_workspace:
                # Must be absolute path or relative path from working_directory
                at: /tmp/workspace

            - run: |
                if [[ `cat /tmp/workspace/echo-output` == "Hello, world!" ]]; then
                  echo "It worked!";
                else
                  echo "Nope!"; exit 1
                fi

workflows:
    version: 2
    build-test-deploy:
        jobs:
            - prepare-dependencies
            - build-production:
                  requires:
                      - prepare-dependencies
            - test:
                  requires:
                      - prepare-dependencies
            - test2:
                  requires:
                      - test
